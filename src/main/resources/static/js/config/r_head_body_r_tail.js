function getData() {
    return {
        formatFunc: {
            // 金额格式
            amt: function(amt){
                return amt;
            },
            // 数量格式化
            num: function(amt){
                return amt;
            },
            // 单价格式化
            unitPrice: function(amt){
                return amt;
            }
        },
        "isCustomerConfig": 1,
        "order": {
            "voucher": "0.00",
            "customer_first_name": "First Name",
            "order_number": "300034416",
            "created_at": "2014-10-15 18:36:05 +0800",
            "created_at_show": "15 Oct 2014",// 程序添加
            "invoice_date_show": "04 Jue 2019",// 程序添加
            "currencyShow": "SGB",// 程序添加
            "paid_price_sum": "2.00",// 程序添加
            "paid_price_voucher_sum": "2.00",// 程序添加
            "voucher_code": "3432",
            "gift_option": "0",
            "shipping_fee": "0.00",
            "branch_number": "2222",
            "tax_code": "1234",
            "customer_last_name": "last_name",
            "updated_at": "2014-10-15 18:36:05 +0800",
            "promised_shipping_times": "2017-03-24 16:09:22",
            "items_count": "1",
            "price": "99.00",
            "delivery_info": "1",
            "statuses": "delivered",
            "address_billing": {
                "country": "Singapore",
                "address3": "address3",
                "address2": "address2",
                "city": "Singapore-Central",
                "phone": "81***8",
                "address1": "22 leonie hill road, #13-01",
                "post_code": "239195",
                "phone2": "24***22",
                "last_name": "Last Name",
                "address5": "address5",
                "address4": "address4",
                "first_name": "First Name"
            },
            "national_registration_number": "1123",
            "extra_attributes": "{\"TaxInvoiceRequested\":\"true\"}",
            "order_id": "16090",
            "gift_message": "Gift",
            "payment_method": "COD",
            "remarks": "remarks",
            "address_shipping": {
                "country": "Singapore",
                "address3": "address3",
                "address2": "address2",
                "city": "Singapore-Central",
                "phone": "94236248",
                "address1": "318 tanglin road, phoenix park, #01-59",
                "post_code": "247979",
                "phone2": "1******2",
                "last_name": "Last Name",
                "address5": "1******2",
                "address4": "address4",
                "first_name": "First Name"
            },
            "itemLi": [
                {
                    "paid_price": "99.00",
                    "product_main_image": "https://www.baidu.com/img/PCtm_d9c8750bed0b3c7d089fa7d55720d6cf.png",
                    "tax_amount": "6.48",
                    "voucher_platform": "0.00",
                    "reason": "reason",
                    "product_detail_url": "https://cn.bing.com/",
                    "promised_shipping_time": "2014-10-15 19:12:15 +0800",
                    "purchase_order_id": "3454",
                    "voucher_seller": "0.00",
                    "shipping_type": "Dropshipping",
                    "created_at": "2014-10-15 19:12:15 +0800",
                    "voucher_code": "X3453",
                    "package_id": "345",
                    "variation": "1",
                    "wallet_credits": "0.00",
                    "updated_at": "2014-10-15 19:12:15 +0800",
                    "purchase_order_number": "345345",
                    "currency": "SGD",
                    "shipping_provider_type": "standard",
                    "sku": "BRSD#02",
                    "invoice_number": "1342",
                    "cancel_return_initiator": "cancellation-customer",
                    "shop_sku": "BE494HLAAUE3SGAMZ-39898",
                    "is_digital": "0",
                    "item_price": "99.00",
                    "shipping_service_cost": "0",
                    "tracking_code_pre": "23534",
                    "tracking_code": "456",
                    "shipping_amount": "0.00",
                    "order_item_id": "98108",
                    "reason_detail": "reason detail",
                    "shop_id": "dawen dp",
                    "return_status": "1",
                    "name": "Bean Rester Dooby Red",
                    "shipment_provider": "LEL",
                    "voucher_amount": "0.00",
                    "digital_delivery_info": "delivery",
                    "extra_attributes": "null",
                    "order_id": "31202",
                    "status": "canceled"
                },
                {
                    "paid_price": "99.00",
                    "product_main_image": "https://www.baidu.com/img/PCtm_d9c8750bed0b3c7d089fa7d55720d6cf.png",
                    "tax_amount": "6.48",
                    "voucher_platform": "0.00",
                    "reason": "reason",
                    "product_detail_url": "https://cn.bing.com/",
                    "promised_shipping_time": "2014-10-15 19:12:15 +0800",
                    "purchase_order_id": "3454",
                    "voucher_seller": "0.00",
                    "shipping_type": "Dropshipping",
                    "created_at": "2014-10-15 19:12:15 +0800",
                    "voucher_code": "X3453",
                    "package_id": "345",
                    "variation": "1",
                    "wallet_credits": "0.00",
                    "updated_at": "2014-10-15 19:12:15 +0800",
                    "purchase_order_number": "345345",
                    "currency": "SGD",
                    "shipping_provider_type": "standard",
                    "sku": "BRSD#02",
                    "invoice_number": "1342",
                    "cancel_return_initiator": "cancellation-customer",
                    "shop_sku": "BE494HLAAUE3SGAMZ-39898",
                    "is_digital": "0",
                    "item_price": "99.00",
                    "shipping_service_cost": "0",
                    "tracking_code_pre": "23534",
                    "tracking_code": "456",
                    "shipping_amount": "0.00",
                    "order_item_id": "98108",
                    "reason_detail": "reason detail",
                    "shop_id": "dawen dp",
                    "return_status": "1",
                    "name": "Bean Rester Dooby Red",
                    "shipment_provider": "LEL",
                    "voucher_amount": "0.00",
                    "digital_delivery_info": "delivery",
                    "extra_attributes": "null",
                    "order_id": "31202",
                    "status": "canceled"
                }
            ]
        }
    }
}

function getFormData() {
    var data = {};
    var value = $('#configForm').serializeArray();
    $.each(value, function (index, item) {
        data[item.name] = item.value;
    });

    // 将未勾上的 checkbox, 值置为 0
    $('#configForm input[type="checkbox"]').each(function(index, item){
        var key = $(item).attr("name");
        if (!$(item).prop("checked") && !data[key]) {
            data[key] = "0";
        }
    });

    $('#configForm input[type="radio"]').each(function(index, item){
        var key = $(item).attr("name");
        if (!$(item).prop("checked") && !data[key]) {
            data[key] = "0";
        }
    });

    // console.log("data is:");
    // console.log(data);
    return data;
}

function getXml() {
    var xml = null;
    $.ajax({
        method: 'GET',
        async: false,
        contentType: "application/json; charset=UTF-8",
        dataType: "json",
        url: contextPath + "/config/getXml.json?fileName=r_head_body_r_tail",
        data: null,
        success: function (result) {
            xml = result.xmlContent;
        },
        error: function (err) {
            console.error(err);
        }
    });
    return xml;
}

function applyBodyAttribute() {
    // body,宽,高,rotate 赋值
    var bodyMetaObj = nanhuprintEval_metaObj[nanhuprintEval_body_id];
    var widthString = nanhuprintEval_getCssAttribute(bodyMetaObj, "ifAndForEachAndSet", "width");
    if (widthString) {
        widthString = widthString.replace(/^\s+|[\s;]+$/g, "");// 清除表头,表尾空格分号
    }
    var heightString = nanhuprintEval_getCssAttribute(bodyMetaObj, "ifAndForEachAndSet", "height");
    if (heightString) {
        heightString = heightString.replace(/^\s+|[\s;]+$/g, "");// 清除表头,表尾空格分号
    }
    var rotate = (bodyMetaObj.rotate && bodyMetaObj.rotate == "true") ? true : false;
    if (rotate) {
        if (!widthString || !heightString) {
            throw new Error("body 配置了 rotate='true', width 和 height 必须同时有值!");
        }
        $("#rightArea").css("width", heightString);
        $("#rightArea").css("height", widthString);
    } else {
        console.log("^^^^ widthString is:" + widthString + ",heightString is:" + heightString);
        if (widthString) {
            $("#rightArea").css("width", widthString);
        }
        if (heightString) {
            $("#rightArea").css("height", heightString);
        }
    }
}

function getSubmitData() {
    var data = getData();
    var formData = getFormData();
    data.printConfigTemplate = formData;
    data.printConfigTemplate.fontFamily = "arial";
    return data;
}

function genHtml() {
    var xml = getXml();
    var data = getSubmitData();

    // console.log("data is:");
    // console.log(JSON.stringify(data));

    var nanhuprintInterpreter = new NanhuprintInterpreter();
    nanhuprintInterpreter.interpreterString(xml, data);

    applyBodyAttribute();

    // console.log("data.nanhuprint_result is:");
    // console.log(data.nanhuprint_result);

    // console.log("data.nanhuprint_result.step1Xml is:");
    // console.log(data.nanhuprint_result.step1Xml);

    // console.log("data.nanhuprint_result.step2Html is:");
    // console.log(data.nanhuprint_result.step2Html);

    var step2Html = data.nanhuprint_result.step2Html;
    // var regExp = new RegExp("<body [^>]*?>(.*?)<\\/body>", "msi");
    var regExp = new RegExp("<body [^>]*?>(.*?)<\\/body>", "mi");
    if (regExp.test(step2Html)) {
        var bodyContent = RegExp.$1;
        $("#rightArea").html(bodyContent);
    }

    nanhuprintEval_clearAll();
}

/**
 * 生成 pdf
 */
function genPdf() {
    document.forms["pdfForm"].printConfigJSON.value = JSON.stringify(getSubmitData());
    document.forms["pdfForm"].submit();
}

function init() {
    $('#configForm input[type="checkbox"]').click(function(){
        genHtml();
    });
    $('#configForm input[type="radio"]').click(function(){
        genHtml();
    });
    $('#configForm input[type="text"]').blur(function(){
        genHtml();
    });

    genHtml();
}

$(document).ready(function(){
    init();
});
